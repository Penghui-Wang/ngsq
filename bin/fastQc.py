import sys
import os
import json

dirname = os.path.dirname(os.path.abspath(__file__))
dirname = os.path.join(dirname,"../")
sys.path.append(dirname)
from ngsqc.fastqc.FastQC import FastQC
from ngsqc.arranger.arranger import arranger
from ngsqc.reporter.reporter import report

def main(fqjson,prefix):
    # load input files
    fqs = []
    indict = json.loads(open(fqjson).read())
    for prex,pair in indict.items():
        for item in pair:
            fqs.append(item)

    # start pipeline 
    qcer = FastQC(fqs,prefix)
    qcer.byfastqc()
    qcer.byfastp()

    # arranger out file to attachment
    arr = arranger(prefix)
    arr.arrange()
    rdir = arr.report

    # auto report
    report(rdir,prefix)

if __name__ == "__main__":
    usage = '''
Usage:
    fastQc.py -i <json> -o <prefix> [--dry=<boolen>] [--docker=<boolen>]
    fastQc.py -h | --help
    fastQc.py -v | --version

Options:
    -h --help                         print usage
    -v --version                      print version information
    -i <json> --input <json>          json generated by smartFqs
    -o <prefix> --outprefix <prefix>  output prefix
    --dry=<boolen>                    dry run [default: True]
    --docker=<boolen>                 run within docker [default: False]                    
    '''   

    from docopt import docopt
    args = docopt(usage) 
    ijson = args["--input"]
    prex = args["--outprefix"]
    main(ijson,prex) 



